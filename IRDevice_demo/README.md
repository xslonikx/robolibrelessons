# Работа с инфракрасным пультом  

На данном занятии мы будем учиться управлять устройствами с помощью пульта ДУ с инфракрасным передатчиком, знакомого всем, у кого есть телевизор, видеоплеер и прочая бытовая техника.

[исходный код скетча](./IRDevice_demo.ino)  
[схема подключения](./sketch_bb.svg)  
и ee [исходник] в программе Fritzing(./sketch.fzz)  

# Немного теории

<details>
    <summary>Минутка копипасты из википедии - что такое инфракрасное излучение</summary>
<i>Инфракрасное излучение</i> - электромагнитное излучение, лежащее в диапазоне между микроволновым радиоизлучением (λ ~ 1—2 мм, f ~ 300 ГГц) и красной границей видимого света (λ = 0,74 мкм, f ~ 430 ТГц).  

Также называется <i>тепловым излучением</i>, поскольку кожей человека излучение от нагретых тел ощущается как тепло. Как мы помним из курса физики - каждое нагретое тело (нагретое - значит хоть на немного теплее абсолютного нуля) излучает электромагнитные волны, и чем сильнее нагрето тело, тем выше как интенсивность излучения, так и его частота. Излучение от нагретых до сравнительно небольших температур тел (до ~1000К) лежит как раз в инфракрасном диапазоне. А выше - тело разогревается докрасна, дожелта, добела и т.д.  

Ремарка - этим же явлением, к слову,  объясняется цвет наблюдаемых на небе звезд. Самые холодные звезды из видимых - красные (хотя есть и холоднее), а самые горячие - голубые. 
</details>
# Демонстрационное устройство

Мы рассмотрим работу с пультом на примере примитивного устройства, содержащего в качестве "полезной функции" RGB-светодиод, а также светодиод, служащий индикатором режима работы.  
В рабочем режиме устройство будет реагировать только на кнопки "ОК" (переключиться в режим настройки) и "#" ("ждущий режим", выключить светодиод, но питание на плату подается). 

В режиме "настройки", который будет отображаться зеленым светодиодом, мы сможем кнопками "вправо/влево" выбирать цветовой канал (красный, зеленый или синий) и кнопками "вверх/вниз" задавать его интенсивность.  
По повторному нажатию кнопки "ОК" перейти обратно в обычный режим и сохранить заданные значения.  

Замечание: Для простоты примера мы условимся, что значения будут храниться только пока подается питание на плату, и не будем сейчас разбирать сохранение их в EEPROM.

Из деталей нам понадобится:  
+ катодный RGB-светодиод  
+ один одноцветный светодиод  
+ резистор 220 Ом - 4 шт.  
+ комплект из IR-приемника и пульта - например, [этот](http://roboshop.spb.ru/IR_Remote_kit). Как раз с использованием его построен пример.  

Схема подключения примерно такова. Каналы RGB светодиода подключаем к ШИМ-портам контроллера (в данном примере это пины 3,5,6 для красного, зеленого и синего соответственно).  
На пин 2 (который поддерживает прерывания) вешаем ногу S (signal) ИК-приемника, а светодиод "питания" вешаем на любой оставшийся цифровой пин (в примере это 11).
И не забываем про резисторы при светодиодах, конечно же)

У ИК-приемника три ноги - нога "минус", нога сигнала и питание. Ногу сигнала мы уже соединили с контроллером. Нога "минус" тянется к "земле" контроллера, к общему минусу схемы.  
Про питание же стоит отметить отдельно - датчик питается от 3.3В, а не от 5В, как написано в некоторых мануалах! Если включить датчик в 5В, датчик на выходе будет отдавать случайный "мусор" вместо стабильных значений. 

# Исходный код
Так глубокого погружения на низкий уровень работы протоколов инфракрасной передачи мы не планируем, мы воспользуемся готовой библиотекой для работы с IR, которая будет скрывать от нас внутреннюю механику инфракрасной связи и предоставит нам лишь простые функции вроде "прочитать/записать".  
Пример, используемый в занятии, написан с использованием библиотеки IRLib2 (ссылка на библиотеку внизу). Она отсутствует в стандартной поставке Arduino IDE, поэтому ее придется скачать отдельно по ссылке внизу статьи и подключить к проекту. Эта библиотека достаточно активно развивается и поддерживается, умеет декодировать различные протоколы передачи сигналов и достаточно проста в использовании.  
К слову, для Arduino существует несколько популярных библиотек для работы с инфракрасными пультами (например, IRRemote), так что вы вольны выбрать любую из них и скорректировать код соответствующим образом.   


<details>
    <summary>Минутка оправданий про стиль написания кода.</summary>
Демонстрационный скетч написан с образовательной целью, чтобы, помимо достижения основной цели также показать некоторые возможностия языков C/C++, на которых основан язык Arduino - такие как [структуры](https://younglinux.info/c/structure), [массивы](https://learnc.info/c/arrays.html), [пользовательские типы данных](http://www.c-cpp.ru/books/typedef) и пр. 

Код написан в процедурном стиле (несмотря на поддержку ООП в языке Arduino) и в целом далек от идеала с точки зрения красоты - но он работает. А возможности ООП мы будем постепенно раскрывать в других примерах.

На данном этапе мы следуем принципу "done better than perfect" (попросту - законченное и работающее лучше, чем идеальное, но незавершенное). Техники "правильного", "чистого" написания кода выходит далеко за рамки наших занятий, хотя в целом мы стараемся им следовать.
</details>  

Про ШИМ в Arduino можно прочесть [здесь](https://www.arduino.cc/en/tutorial/PWM) и [здесь](https://www.arduino.cc/en/Tutorial/SecretsOfArduinoPWM)  

Про [IR NEC Protocol](https://www.sbprojects.net/knowledge/ir/nec.php)  
 
Библиотеки:  
[IRLib2](https://github.com/cyborg5/IRLib2)  
